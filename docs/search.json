[
  {
    "objectID": "Analysis.html",
    "href": "Analysis.html",
    "title": "Metagenome Analysis",
    "section": "",
    "text": "Code\nlibrary(tidyverse)\nlibrary(Polychrome)\nlibrary(withr)\nlibrary(fs)\nlibrary(compositions)\n\n\nplot_nuc_survival &lt;- function(df, ylim, ybreaks, ncol){\n  ggplot(df, aes(x=m, y=value, color=name, linetype = name)) + \n    geom_step(direction = \"mid\") +\n    scale_x_continuous(limits = c(0.5, 3.5), \n                       breaks = c(1, 2, 3), \n                       minor_breaks = NULL) +\n    scale_y_log10(breaks = {{ ybreaks }},\n                  labels = scales::trans_format(\"log10\", scales::math_format(10^.x))) + \n    labs(x=(\"Nucleotide multiplicitiy, m\"), \n         y=(\"Total mutations ≥ m\"),\n         color = NULL) +\n    scale_color_manual(values = c(\"blue\", \"red\")) +\n    scale_linetype(guide = 'none') +\n    facet_wrap(~label, ncol = {{ ncol }}) +\n    annotation_logticks(sides = \"l\", color = \"grey40\") +\n    coord_cartesian(ylim = c(1, {{ ylim }})) +\n    theme_bw() +\n    theme(\n      strip.placement = 'outside',\n      strip.background = element_blank(),\n      panel.grid = element_blank(),\n      legend.position = \"bottom\"\n    )\n}"
  },
  {
    "objectID": "Analysis.html#no-vaf-filter",
    "href": "Analysis.html#no-vaf-filter",
    "title": "Metagenome Analysis",
    "section": "No VAF filter",
    "text": "No VAF filter\n\n\nCode\nknitr::kable(HAMBI_mutations)\n\n\n\n\n\nHAMBI\nmi\nn\ntot\n\n\n\n\nHAMBI_0006\n3\n69\n162\n\n\nHAMBI_1842\n3\n12\n162\n\n\nHAMBI_1972\n3\n69\n162\n\n\nHAMBI_1977\n3\n6\n162\n\n\nHAMBI_2659\n3\n6\n162\n\n\nHAMBI_0006\n2\n24\n114\n\n\nHAMBI_0403\n2\n2\n114\n\n\nHAMBI_1842\n2\n8\n114\n\n\nHAMBI_1972\n2\n28\n114\n\n\nHAMBI_1977\n2\n32\n114\n\n\nHAMBI_2659\n2\n20\n114\n\n\nHAMBI_0006\n1\n69\n512\n\n\nHAMBI_0403\n1\n10\n512\n\n\nHAMBI_1287\n1\n40\n512\n\n\nHAMBI_1842\n1\n38\n512\n\n\nHAMBI_1972\n1\n114\n512\n\n\nHAMBI_1977\n1\n121\n512\n\n\nHAMBI_2164\n1\n1\n512\n\n\nHAMBI_2443\n1\n11\n512\n\n\nHAMBI_2659\n1\n108\n512"
  },
  {
    "objectID": "Analysis.html#vaf-0.05",
    "href": "Analysis.html#vaf-0.05",
    "title": "Metagenome Analysis",
    "section": "VAF ≥ 0.05",
    "text": "VAF ≥ 0.05\n\n\nCode\nknitr::kable(HAMBI_mutations_filt)\n\n\n\n\n\nHAMBI\nmi\nn\ntot\n\n\n\n\nHAMBI_0006\n3\n51\n93\n\n\nHAMBI_1842\n3\n9\n93\n\n\nHAMBI_1972\n3\n27\n93\n\n\nHAMBI_1977\n3\n3\n93\n\n\nHAMBI_2659\n3\n3\n93\n\n\nHAMBI_0006\n2\n16\n84\n\n\nHAMBI_0403\n2\n2\n84\n\n\nHAMBI_1842\n2\n8\n84\n\n\nHAMBI_1972\n2\n10\n84\n\n\nHAMBI_1977\n2\n26\n84\n\n\nHAMBI_2659\n2\n22\n84\n\n\nHAMBI_0006\n1\n31\n304\n\n\nHAMBI_0403\n1\n10\n304\n\n\nHAMBI_1287\n1\n5\n304\n\n\nHAMBI_1842\n1\n38\n304\n\n\nHAMBI_1972\n1\n31\n304\n\n\nHAMBI_1977\n1\n78\n304\n\n\nHAMBI_2164\n1\n1\n304\n\n\nHAMBI_2443\n1\n11\n304\n\n\nHAMBI_2659\n1\n99\n304"
  },
  {
    "objectID": "Analysis.html#plot",
    "href": "Analysis.html#plot",
    "title": "Metagenome Analysis",
    "section": "Plot",
    "text": "Plot\nDistribution of nucleotide multiplicity (the number of replicates with with the same genomic mutation) for HAMBI x history x treatment combinations. The observed data in blue, the null expectation in red.\n\n\nCode\nnuc_survival &lt;- variants_filt %&gt;%\n  filter(VAF &gt; 0.05) %&gt;%\n  dplyr::select(HAMBI, History, Experiment, POS, REF, ALT, Replicate) %&gt;% \n  # multiplicity = number of replicate populations each unique mutation is\n  # observed in\n  summarize(m = n_distinct(Replicate), .by = c(HAMBI, History, Experiment, POS, REF, ALT)) %&gt;%\n  # now calculate the total number of mutations across all replicates so we need\n  # to ungroup by mutation position/alt allele but because we still want to\n  # determine this value by treatment category we keep the treatment category\n  # grouping. However, this should be changed if you want to for example average\n  # over all the treatment conditions on a species basis\n  group_by(HAMBI, History, Experiment) %&gt;%\n  count(m, name = \"m_count\") %&gt;%\n  mutate(n = m * m_count,\n         Ntot = sum(n),\n         perc = n / Ntot * 100) %&gt;%\n  left_join(chrom_lengths, by = join_by(HAMBI)) %&gt;%\n  arrange(cur_group_id(), desc(m)) %&gt;%\n  #  dpois() tells the probability mass at a given number of counts. Here we\n  #  want to get the probability of observing n mutations with multiplicity\n  #  = mi (i.e. the counts of mi in the observed data). We assume that\n  #  mutations independently occur on the genome of size Ltot at a rate of\n  #  lambda = Ntot/Ltot and that generally the events are rare. Thus this\n  #  situation can be modeled by the Poisson distribution. We can get the\n  #  binned number of mutations per level of multiplicity m by multiplying\n  #  the probability by the length of the genome and the binned mutations\n  #  divided by the total number of mutations.\n  mutate(m_count_expected = cumsum((m_count / Ntot) *\n                                     sum_bases *\n                                     dpois(m, lambda = Ntot / sum_bases))) %&gt;%\n  #dplyr::select(-num_contigs) %&gt;%\n  relocate(m, n, Ntot, perc, m_count, m_count_expected) %&gt;%\n  ungroup()\n\n# setup for plotting\nnuc_survival_plot &lt;- nuc_survival %&gt;% \n  group_by(HAMBI, History, Experiment) %&gt;% \n  # when there is only one multiplicity observed for a mutation filter such\n  # that the multiplicty of that mutation must be greater than one.\n  # Otherwise include all remaining mutations (m &gt; 0)\n  filter(case_when(n() == 1 ~ m &gt; 1,\n                   TRUE ~ m &gt; 0)) %&gt;% \n  pivot_longer(cols = c(\"m_count\", \"m_count_expected\")) %&gt;% \n  mutate(label = paste(HAMBI, \"History:\", History, \"\\nExperiment:\", Experiment)) %&gt;% \n  # and make final plot\n  plot_nuc_survival(., 5000, c(1, 10, 100, 1000, 10000), 4)\n\nnuc_survival_plot"
  }
]